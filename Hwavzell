package com.project.pertemuan3

import android.graphics.BitmapFactory
import android.os.Bundle
import android.util.Base64
import android.widget.Toast
import androidx.activity.ComponentActivity
import androidx.activity.compose.rememberLauncherForActivityResult
import androidx.activity.compose.setContent
import androidx.activity.enableEdgeToEdge
import androidx.activity.result.contract.ActivityResultContracts
import androidx.compose.foundation.Image
import androidx.compose.foundation.background
import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.grid.GridCells
import androidx.compose.foundation.lazy.grid.LazyVerticalGrid
import androidx.compose.foundation.lazy.grid.items
import androidx.compose.foundation.rememberScrollState
import androidx.compose.foundation.verticalScroll
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.foundation.text.KeyboardOptions
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.Add
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.graphics.Color
import androidx.compose.ui.graphics.asImageBitmap
import androidx.compose.ui.layout.ContentScale
import androidx.compose.ui.platform.LocalContext
import androidx.compose.ui.res.painterResource
import androidx.compose.ui.text.input.KeyboardType
import androidx.compose.ui.text.input.TextFieldValue
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import com.google.firebase.FirebaseApp
import com.google.firebase.database.*
import com.project.pertemuan3.ui.theme.Pertemuan3Theme

data class Fish(
    var name: String = "",
    var map: String = "",
    var price: String = "",
    var photo: String = ""
)

class MainActivity : ComponentActivity() {
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        FirebaseApp.initializeApp(this)
        enableEdgeToEdge()
        setContent {
            Pertemuan3Theme(darkTheme = false) {
                Surface(color = Color(0xFFF9F9F9)) {
                    FirebaseInputScreen()
                }
            }
        }
    }
}

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun FirebaseInputScreen() {
    val context = LocalContext.current
    val dbRef = FirebaseDatabase
        .getInstance("https://pertemuan3-3fd24-default-rtdb.asia-southeast1.firebasedatabase.app")
        .getReference("fishdex")

    var currentScene by remember { mutableStateOf("list") }
    var daftarIkan by remember { mutableStateOf(listOf<Pair<String, Fish>>()) }
    var editId by remember { mutableStateOf<String?>(null) }

    var namaField by remember { mutableStateOf(TextFieldValue("")) }
    var mapField by remember { mutableStateOf(TextFieldValue("")) }
    var priceField by remember { mutableStateOf(TextFieldValue("")) }
    var photoBase64 by remember { mutableStateOf("") }

    var loading by remember { mutableStateOf(true) }

    // ambil data Firebase
    LaunchedEffect(Unit) {
        dbRef.addValueEventListener(object : ValueEventListener {
            override fun onDataChange(snapshot: DataSnapshot) {
                val items = mutableListOf<Pair<String, Fish>>()
                for (child in snapshot.children) {
                    val fish = child.getValue(Fish::class.java)
                    if (fish != null) items.add(child.key!! to fish)
                }
                daftarIkan = items
                loading = false
            }

            override fun onCancelled(error: DatabaseError) {
                loading = false
                Toast.makeText(context, "Error: ${error.message}", Toast.LENGTH_SHORT).show()
            }
        })
    }

    Scaffold(
        topBar = {
            TopAppBar(
                title = { Text("FishDex", fontSize = 30.sp, color = Color.Black) },
                colors = TopAppBarDefaults.topAppBarColors(containerColor = Color(0xFFF9F9F9))
            )
        },
        floatingActionButton = {
            FloatingActionButton(
                onClick = {
                    namaField = TextFieldValue("")
                    mapField = TextFieldValue("")
                    priceField = TextFieldValue("")
                    photoBase64 = ""
                    editId = null
                    currentScene = "form"
                },
                containerColor = Color(0xFF00796B)
            ) {
                Icon(Icons.Default.Add, contentDescription = "Tambah", tint = Color.White)
            }
        },
        containerColor = Color(0xFFF9F9F9)
    ) { paddingValues ->
        Column(
            modifier = Modifier
                .padding(paddingValues)
                .fillMaxSize()
        ) {
            // Header tetap tampil walau loading
            Image(
                painter = painterResource(id = R.drawable.image_header),
                contentDescription = "Header",
                contentScale = ContentScale.Crop,
                modifier = Modifier
                    .fillMaxWidth()
                    .height(180.dp)
            )

            Spacer(modifier = Modifier.height(12.dp))

            Text(
                text = "My Collection",
                fontSize = 24.sp,
                color = Color.Black,
                modifier = Modifier.padding(start = 16.dp, bottom = 8.dp)
            )

            if (loading) {
                Box(Modifier.fillMaxSize(), contentAlignment = Alignment.Center) {
                    CircularProgressIndicator(color = Color(0xFF00796B))
                }
            } else {
                LazyVerticalGrid(
                    columns = GridCells.Fixed(2),
                    modifier = Modifier
                        .fillMaxHeight()
                        .padding(8.dp),
                    verticalArrangement = Arrangement.spacedBy(8.dp),
                    horizontalArrangement = Arrangement.spacedBy(8.dp)
                ) {
                    items(daftarIkan) { (id, fish) ->
                        Card(
                            shape = RoundedCornerShape(16.dp),
                            elevation = CardDefaults.cardElevation(4.dp),
                            modifier = Modifier.height(280.dp)
                        ) {
                            Column {
                                // ðŸ”’ Aman dari crash bitmap null
                                val imageBitmap = remember(fish.photo) {
                                    if (fish.photo.isNotEmpty()) {
                                        try {
                                            val bytes = Base64.decode(fish.photo, Base64.DEFAULT)
                                            val bitmap = BitmapFactory.decodeByteArray(bytes, 0, bytes.size)
                                            bitmap?.asImageBitmap()
                                        } catch (e: Exception) {
                                            null
                                        }
                                    } else null
                                }

                                if (imageBitmap != null) {
                                    Image(
                                        bitmap = imageBitmap,
                                        contentDescription = fish.name,
                                        contentScale = ContentScale.Crop,
                                        modifier = Modifier
                                            .fillMaxWidth()
                                            .height(120.dp)
                                            .clip(RoundedCornerShape(topStart = 16.dp, topEnd = 16.dp))
                                    )
                                } else {
                                    Image(
                                        painter = painterResource(id = R.drawable.image_header),
                                        contentDescription = fish.name,
                                        contentScale = ContentScale.Crop,
                                        modifier = Modifier
                                            .fillMaxWidth()
                                            .height(120.dp)
                                            .clip(RoundedCornerShape(topStart = 16.dp, topEnd = 16.dp))
                                    )
                                }

                                Divider(color = Color.LightGray, thickness = 1.dp)

                                Column(
                                    modifier = Modifier
                                        .padding(10.dp)
                                        .fillMaxWidth(),
                                    horizontalAlignment = Alignment.Start
                                ) {
                                    Text(fish.name, fontSize = 16.sp, color = Color.Black)
                                    Text(fish.map, fontSize = 14.sp, color = Color.Gray)
                                    Text("Rp ${fish.price}", fontSize = 14.sp, color = Color(0xFF00796B))

                                    Spacer(Modifier.height(8.dp))
                                    Row(
                                        modifier = Modifier.fillMaxWidth(),
                                        horizontalArrangement = Arrangement.SpaceBetween
                                    ) {
                                        Button(
                                            onClick = {
                                                editId = id
                                                namaField = TextFieldValue(fish.name)
                                                mapField = TextFieldValue(fish.map)
                                                priceField = TextFieldValue(fish.price)
                                                photoBase64 = fish.photo
                                                currentScene = "form"
                                            },
                                            colors = ButtonDefaults.buttonColors(containerColor = Color(0xFF1976D2)),
                                            modifier = Modifier.weight(1f)
                                        ) {
                                            Text("Edit", color = Color.White, fontSize = 12.sp)
                                        }
                                        Spacer(Modifier.width(4.dp))
                                        Button(
                                            onClick = { dbRef.child(id).removeValue() },
                                            colors = ButtonDefaults.buttonColors(containerColor = Color(0xFFD32F2F)),
                                            modifier = Modifier.weight(1f)
                                        ) {
                                            Text("Hapus", color = Color.White, fontSize = 12.sp)
                                        }
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }

        // ðŸ§¾ FORM INPUT
        if (currentScene == "form") {
            Box(
                Modifier
                    .fillMaxSize()
                    .background(Color(0xAAFFFFFF))
            ) {
                Card(
                    modifier = Modifier
                        .align(Alignment.Center)
                        .padding(16.dp),
                    elevation = CardDefaults.cardElevation(8.dp)
                ) {
                    val launcher = rememberLauncherForActivityResult(
                        contract = ActivityResultContracts.GetContent()
                    ) { uri ->
                        uri?.let {
                            val inputStream = context.contentResolver.openInputStream(it)
                            val bytes = inputStream?.readBytes()
                            inputStream?.close()
                            if (bytes != null) {
                                photoBase64 = Base64.encodeToString(bytes, Base64.DEFAULT)
                            }
                        }
                    }

                    Column(
                        modifier = Modifier
                            .padding(20.dp)
                            .fillMaxWidth(),
                        verticalArrangement = Arrangement.spacedBy(10.dp)
                    ) {
                        Text("Form Data Ikan", fontSize = 18.sp, color = Color.Black)
                        UnderlineTextField(namaField, { namaField = it }, "Nama Ikan")
                        UnderlineTextField(mapField, { mapField = it }, "Map")
                        UnderlineTextField(priceField, { priceField = it }, "Harga", keyboardType = KeyboardType.Number)

                        Button(
                            onClick = { launcher.launch("image/*") },
                            colors = ButtonDefaults.buttonColors(containerColor = Color(0xFF1976D2))
                        ) {
                            Text("Pilih Gambar", color = Color.White)
                        }

                        if (photoBase64.isNotEmpty()) {
                            val imgBitmap = remember(photoBase64) {
                                try {
                                    val bytes = Base64.decode(photoBase64, Base64.DEFAULT)
                                    val bitmap = BitmapFactory.decodeByteArray(bytes, 0, bytes.size)
                                    bitmap?.asImageBitmap()
                                } catch (e: Exception) { null }
                            }

                            imgBitmap?.let {
                                Image(
                                    bitmap = it,
                                    contentDescription = "Preview",
                                    modifier = Modifier
                                        .fillMaxWidth()
                                        .height(150.dp)
                                        .clip(RoundedCornerShape(12.dp))
                                )
                            }
                        }

                        Row(
                            modifier = Modifier.fillMaxWidth(),
                            horizontalArrangement = Arrangement.SpaceBetween
                        ) {
                            Button(
                                onClick = {
                                    val fish = Fish(
                                        name = namaField.text,
                                        map = mapField.text,
                                        price = priceField.text,
                                        photo = photoBase64
                                    )
                                    if (editId != null) dbRef.child(editId!!).setValue(fish)
                                    else dbRef.push().setValue(fish)
                                    currentScene = "list"
                                },
                                modifier = Modifier.weight(1f),
                                colors = ButtonDefaults.buttonColors(containerColor = Color(0xFF00796B))
                            ) {
                                Text("Simpan", color = Color.White)
                            }
                            Spacer(modifier = Modifier.width(8.dp))
                            Button(
                                onClick = { currentScene = "list" },
                                modifier = Modifier.weight(1f),
                                colors = ButtonDefaults.buttonColors(containerColor = Color.Gray)
                            ) {
                                Text("Batal", color = Color.White)
                            }
                        }
                    }
                }
            }
        }
    }
}

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun UnderlineTextField(
    value: TextFieldValue,
    onValueChange: (TextFieldValue) -> Unit,
    label: String,
    keyboardType: KeyboardType = KeyboardType.Text
) {
    Column {
        Text(
            text = label,
            color = Color.Gray,
            fontSize = 14.sp,
            modifier = Modifier.padding(bottom = 2.dp)
        )
        TextField(
            value = value,
            onValueChange = onValueChange,
            modifier = Modifier.fillMaxWidth(),
            colors = TextFieldDefaults.textFieldColors(
                containerColor = Color.Transparent,
                focusedIndicatorColor = Color(0xFF00796B),
                unfocusedIndicatorColor = Color.LightGray,
                cursorColor = Color(0xFF00796B)
            ),
            keyboardOptions = KeyboardOptions(keyboardType = keyboardType),
            singleLine = true
        )
    }
}
