#include <ESP8266WiFi.h>
#include <ESP8266HTTPClient.h>
#include <DHT.h>

// -----------------------------
// KONFIGURASI WiFi
// -----------------------------
const char* ssid = "suki";
const char* password = "12345678";

// -----------------------------
// KONFIGURASI SERVER
// -----------------------------
const char* serverName = "http://192.168.137.1/dht11/insert.php";

// -----------------------------
// KONFIGURASI SENSOR DHT11
// -----------------------------
#define DHTPIN 2       // Pin data DHT11 = D4 pada NodeMCU
#define DHTTYPE DHT11

DHT dht(DHTPIN, DHTTYPE);

const int device_id = 1;

void setup() {
  Serial.begin(115200);

  dht.begin();

  WiFi.begin(ssid, password);

  Serial.print("Menghubungkan ke WiFi");
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println("\nWiFi terhubung!");
}

void loop() {

  float humidity = dht.readHumidity();
  float temperature = dht.readTemperature();

  if (isnan(humidity) || isnan(temperature)) {
    Serial.println("Gagal membaca dari DHT11!");
    delay(2000);
    return;
  }

  // -----------------------------
  // KIRIM DATA KE SERVER
  // -----------------------------
  if (WiFi.status() == WL_CONNECTED) {
    WiFiClient client;
    HTTPClient http;

    String postData = "device_id=" + String(device_id) +
                      "&sensor_type=DHT11" +
                      "&temperature=" + String(temperature) +
                      "&humidity=" + String(humidity);

    http.begin(client, serverName);
    http.addHeader("Content-Type", "application/x-www-form-urlencoded");

    int httpCode = http.POST(postData);

    if (httpCode > 0) {
      String payload = http.getString();
      Serial.println("Respon Server: " + payload);
    } else {
      Serial.print("Gagal mengirim data. Error: ");
      Serial.println(httpCode);
    }

    http.end();
  }

  delay(10000); // kirim setiap 10 detik
}